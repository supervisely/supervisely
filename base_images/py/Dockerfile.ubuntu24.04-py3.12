# Dockerfile for migration to Ubuntu 24.04 + Python 3.12
# https://hub.docker.com/r/supervisely/base-py

# NEW base image with Ubuntu 24.04 (Python 3.12 by default)
FROM nvidia/cuda:12.2-cudnn-runtime-ubuntu24.04

##############################################################################
# System configuration and common packages
##############################################################################

# Setting up locale to avoid encoding issues
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive

# System update and installation of basic packages
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        curl \
        nano \
        ca-certificates \
        libjpeg-dev \
        libpng-dev \
        software-properties-common \
        pkg-config \
        libssl-dev \
        libffi-dev \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

##############################################################################
# Python 3.12 (already installed by default in Ubuntu 24.04)
##############################################################################

# Installing pip and dev packages for Python 3.12
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv \
        python3-wheel \
        python3-setuptools \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

# Creating symbolic links for compatibility
RUN update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3 1

# Upgrading pip to the latest version
RUN python3 -m pip install --upgrade pip setuptools wheel

##############################################################################
# System dependencies for Python packages (UPDATED for Ubuntu 24.04)
##############################################################################

# libgeos for shapely; other dependencies for cv2 and ML libraries
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        libgeos-dev \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libgtk-3-0 \
        libavcodec-dev \
        libavformat-dev \
        libswscale-dev \
        libv4l-dev \
        libxvidcore-dev \
        libx264-dev \
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libatlas-base-dev \
        gfortran \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

##############################################################################
# UPDATED Python dependencies (compatible with Python 3.12)
##############################################################################

# Main scientific libraries (updated versions)
RUN pip install --no-cache-dir \
        python-json-logger>=2.0.7 \
        pybase64>=1.3.2 \
        shapely>=2.0.2 \
        imgaug>=0.4.0 \
        numpy>=1.24.3,<2.0.0 \
        opencv-python>=4.8.1.78,<5.0.0 \
        scipy>=1.11.4,<2.0.0 \
        scikit-image>=0.21.0,<1.0.0 \
        matplotlib>=3.7.2,<4.0.0 \
        pillow>=10.0.1,<11.0.0 \
        requests>=2.31.0,<3.0.0 \
        networkx>=3.1,<4.0 \
        jsonschema>=4.19.0,<5.0.0

# Additional dependencies
RUN pip install --no-cache-dir \
    pandas>=2.1.1,<3.0.0 \
    grpcio>=1.59.0,<2.0.0 \
    grpcio-tools>=1.59.0,<2.0.0

##############################################################################
# Java for PyCharm (UPDATED for Ubuntu 24.04)
##############################################################################

RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        default-jre \
        default-jdk \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

# Updating JAVA_HOME for Ubuntu 24.04
ENV JAVA_HOME=/usr/lib/jvm/default-java

##############################################################################
# Additional libraries (UPDATED VERSIONS)
##############################################################################

# System dependencies for additional libraries
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libexiv2-dev \
        libboost-all-dev \
        libmagic-dev \
        openssh-server \
        ffmpeg \
        fonts-noto \
    && mkdir -p /var/run/sshd \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

# Python libraries (updated versions)
RUN pip install --no-cache-dir \
    requests-toolbelt>=1.0.0 \
    PTable>=0.9.2 \
    flask-restful>=0.3.10 \
    pascal-voc-writer>=0.1.4 \
    bidict>=0.22.1 \
    scikit-video>=1.1.11 \
    plotly>=5.17.0 \
    docker>=6.1.3 \
    fuzzywuzzy[speedup]>=0.18.0 \
    xlrd>=2.0.1 \
    google-cloud-storage>=2.10.0 \
    python-slugify>=8.0.1 \
    psutil>=5.9.5 \
    cython>=3.0.2 \
    protobuf>=4.24.4 \
    Werkzeug>=2.3.7

##############################################################################
# Final configuration
##############################################################################

# Checking versions to confirm installation
RUN python --version && \
    pip --version && \
    python -c "import numpy; print(f'NumPy: {numpy.__version__}')" && \
    python -c "import cv2; print(f'OpenCV: {cv2.__version__}')" && \
    python -c "import pandas; print(f'Pandas: {pandas.__version__}')"

# Setting encoding for SDK
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Working directory
WORKDIR /workspace

# Label for image identification
LABEL maintainer="Supervisely Team"
LABEL python.version="3.12"
LABEL ubuntu.version="24.04"
LABEL description="Supervisely base image with Python 3.12 on Ubuntu 24.04"
