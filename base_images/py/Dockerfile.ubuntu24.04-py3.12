# Dockerfile for migration to Ubuntu 24.04 + Python 3.12
# https://hub.docker.com/r/supervisely/base-py

# NEW base image with Ubuntu 24.04 (Python 3.12 by default)
# CUDA 13.0.1 meets requirements: CUDA >=12.8, driver >=570.26, PyTorch >=2.7.0
FROM nvidia/cuda:13.0.1-cudnn-runtime-ubuntu24.04

##############################################################################
# System configuration and common packages
##############################################################################

# Setting up locale to avoid encoding issues
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV DEBIAN_FRONTEND=noninteractive

# System update and installation of basic packages
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        curl \
        nano \
        ca-certificates \
        libjpeg-dev \
        libpng-dev \
        software-properties-common \
        pkg-config \
        libssl-dev \
        libffi-dev \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

##############################################################################
# Python 3.12 (already installed by default in Ubuntu 24.04)
##############################################################################

# Installing Python 3.12, pip and ALL available scientific libraries from Ubuntu 24.04
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv \
        python3-wheel \
        python3-setuptools \
        python3-numpy \
        python3-scipy \
        python3-matplotlib \
        python3-pandas \
        python3-opencv \
        python3-networkx \
        python3-jsonschema \
        python3-grpcio \
        python3-requests \
        python3-flask \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

# Creating symbolic links for compatibility
RUN update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3 1

# Upgrade ALL system Python packages to latest available versions
RUN apt-get update \
    && apt-get upgrade -y \
        python3-pip python3-setuptools python3-wheel \
        python3-numpy python3-scipy python3-matplotlib \
        python3-pandas python3-opencv python3-networkx \
        python3-jsonschema python3-grpcio python3-requests \
        python3-flask \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

##############################################################################
# System dependencies for Python packages (UPDATED for Ubuntu 24.04)
##############################################################################

# libgeos for shapely; other dependencies for cv2 and ML libraries (UPDATED for Ubuntu 24.04)
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        libgeos-dev \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgl1-mesa-dev \
        libglu1-mesa-dev \
        libglib2.0-0 \
        libgtk-3-0 \
        libavcodec-dev \
        libavformat-dev \
        libswscale-dev \
        libv4l-dev \
        libxvidcore-dev \
        libx264-dev \
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libatlas-base-dev \
        gfortran \
        pkg-config \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

##############################################################################
# UPDATED Python dependencies (compatible with Python 3.12)
# Note: Using --break-system-packages due to PEP 668 in Ubuntu 24.04
##############################################################################

# Additional Python libraries NOT available in Ubuntu 24.04 or needing newer versions
# Most scientific libraries are already installed via apt above
RUN pip install --no-cache-dir --break-system-packages \
        "python-json-logger>=2.0.7" \
        "pybase64>=1.3.2" \
        "shapely>=2.0.2" \
        "imgaug>=0.4.0" \
        "scikit-image>=0.21.0" \
        "pillow>=10.0.1"

# Additional dependencies not available via apt
RUN pip install --no-cache-dir --break-system-packages \
    "grpcio-tools>=1.59.0"

##############################################################################
# Java for PyCharm (UPDATED for Ubuntu 24.04)
##############################################################################

RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        default-jre \
        default-jdk \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log

# Updating JAVA_HOME for Ubuntu 24.04
ENV JAVA_HOME=/usr/lib/jvm/default-java

##############################################################################
# Additional libraries (UPDATED VERSIONS)
##############################################################################

# System dependencies for additional libraries
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libexiv2-dev \
        libboost-all-dev \
        libmagic-dev \
        openssh-server \
        ffmpeg \
        fonts-noto \
    && mkdir -p /var/run/sshd \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/*

# Python libraries (updated versions) - split to avoid system package conflicts
RUN pip install --no-cache-dir --break-system-packages \
    "requests-toolbelt>=1.0.0" \
    "PTable>=0.9.2" \
    "pascal-voc-writer>=0.1.4" \
    "bidict>=0.22.1" \
    "scikit-video>=1.1.11" \
    "plotly>=5.17.0" \
    "docker>=6.1.3" \
    "fuzzywuzzy[speedup]>=0.18.0" \
    "xlrd>=2.0.1" \
    "google-cloud-storage>=2.10.0" \
    "python-slugify>=8.0.1" \
    "psutil>=5.9.5" \
    "cython>=3.0.2" \
    "protobuf>=4.24.4"

# Install Flask-related packages compatible with system Flask 3.0.2
RUN pip install --no-cache-dir --break-system-packages \
    "flask-restful>=0.3.10" \
    "Werkzeug>=3.0.0"

##############################################################################
# Final configuration
##############################################################################

# Checking versions to confirm installation
RUN python --version && \
    pip --version && \
    python -c "import setuptools; print(f'Setuptools: {setuptools.__version__} (system)')" && \
    python -c "import wheel; print(f'Wheel: {wheel.__version__} (system)')" && \
    python -c "import numpy; print(f'NumPy: {numpy.__version__} (system)')" && \
    python -c "import scipy; print(f'SciPy: {scipy.__version__} (system)')" && \
    python -c "import matplotlib; print(f'Matplotlib: {matplotlib.__version__} (system)')" && \
    python -c "import pandas; print(f'Pandas: {pandas.__version__} (system)')" && \
    python -c "import cv2; print(f'OpenCV: {cv2.__version__} (system)')" && \
    python -c "import networkx; print(f'NetworkX: {networkx.__version__} (system)')" && \
    python -c "import jsonschema; print(f'JSONSchema: {jsonschema.__version__} (system)')" && \
    python -c "import grpc; print(f'gRPC: {grpc.__version__} (system)')" && \
    python -c "import requests; print(f'Requests: {requests.__version__} (system)')" && \
    python -c "import flask; print(f'Flask: {flask.__version__} (system)')"

# Setting encoding for SDK
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Working directory
WORKDIR /workspace

# Label for image identification
LABEL maintainer="Supervisely Team"
LABEL python.version="3.12"
LABEL ubuntu.version="24.04"
LABEL description="Supervisely base image with Python 3.12 on Ubuntu 24.04"
